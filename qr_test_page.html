<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community Bingo — QR Test</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    .controls { display: grid; gap: 8px; margin-bottom: 16px; }
    label { font-size: .9rem; color: #333; }
    input, textarea, button { width: 100%; padding: 10px; font: inherit; border: 1px solid #ccc; border-radius: 8px; }
    button { cursor: pointer; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 10px; display: grid; gap: 6px; align-content: start; }
    .url { font-size: .75rem; word-break: break-all; color: #444; }
    .title { font-weight: 600; font-size: .9rem; text-align: center; }
    .label-above { font-size: .85rem; font-weight: 500; text-align: center; margin-bottom: 4px; }
  .element { font-size: 2rem; text-align: center; }
    .qrBox { position: relative; width: 128px; height: 128px; margin: 0 auto; }
    .qrOverlay { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: white; font-size: 1.5rem; box-shadow: 0 0 0 2px rgba(0,0,0,0.05) inset; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <h1>QR Test — Community Bingo</h1>
  <div class="controls">
    <label>
      Base URL (where your bingo board lives)
      <input id="baseUrl" />
    </label>
    <label>
      Fill IDs (comma-separated, optional; if empty, will load board_squares.json and generate one QR per index)
      <textarea id="ids" rows="3" placeholder="e.g., 0,1,2,5,8"></textarea>
    </label>
    <label style="display:flex; gap:8px; align-items:center;">
      <input type="checkbox" id="overlay" />
      Overlay element inside QR (experimental)
    </label>
    <button id="gen">Generate QRs</button>
  </div>

  <div class="grid" id="qrGrid"></div>

  <script>
    let ITEMS = null; // content of board_squares.json (array)

    (function setDefaultBase(){
      const here = new URL(window.location.href);
      const base = new URL('./index.html', here).href;
      document.getElementById('baseUrl').value = base;
    })();

    async function loadItems() {
      if (ITEMS) return ITEMS;
      try {
        const res = await fetch('board_squares.json');
        if (!res.ok) throw new Error('Failed to load board_squares.json');
        ITEMS = await res.json();
        return ITEMS;
      } catch (e) {
        ITEMS = null;
        return null;
      }
    }

    async function getAllIndices() {
      const arr = await loadItems();
      if (Array.isArray(arr)) {
        return Array.from({length: arr.length}, (_, i) => i);
      } else {
        alert('Could not load board_squares.json. Enter IDs manually.');
        return [];
      }
    }

    function makeQR(container, text) {
      container.innerHTML = '';
      new QRCode(container, {
        text,
        width: 128,
        height: 128,
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    function buildUrl(base, ids) {
      const url = new URL(base);
      url.searchParams.set('fill', ids.join(','));
      return url.toString();
    }

    function overlayElement(qrContainer, label) {
      const overlay = document.createElement('div');
      overlay.className = 'qrOverlay';
      overlay.textContent = label;
      qrContainer.appendChild(overlay);
    }

    document.getElementById('gen').addEventListener('click', async () => {
      const base = document.getElementById('baseUrl').value.trim();
      const raw = document.getElementById('ids').value.trim();
      const doOverlay = document.getElementById('overlay').checked;
      const grid = document.getElementById('qrGrid');
      grid.innerHTML = '';

      let idsList = [];
      if (raw) {
        idsList = raw.split(',').map(s => s.trim()).filter(Boolean).map(Number).filter(n => Number.isInteger(n) && n >= 0);
      } else {
        idsList = await getAllIndices();
      }

      if (!base) { alert('Enter a base URL'); return; }
      if (!idsList.length) { alert('No IDs to render'); return; }

      const items = await loadItems();

      idsList.forEach((id) => {
        const url = buildUrl(base, [id]);
        const card = document.createElement('div');
        card.className = 'card';

        const elementLabel = Array.isArray(items) && items[id] != null ? String(items[id]) : `ID ${id}`;

        const elementDiv = document.createElement('div');
        elementDiv.className = 'element';
        elementDiv.textContent = elementLabel;
        card.appendChild(elementDiv);

        const qrBox = document.createElement('div');
        qrBox.className = 'qrBox';
        const qr = document.createElement('div');
        qrBox.appendChild(qr);
        card.appendChild(qrBox);

        const u = document.createElement('div');
        u.className = 'url';
        u.textContent = url;
        card.appendChild(u);

        document.getElementById('qrGrid').appendChild(card);

        makeQR(qr, url);

        if (doOverlay) {
          overlayElement(qrBox, elementLabel);
          elementDiv.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
